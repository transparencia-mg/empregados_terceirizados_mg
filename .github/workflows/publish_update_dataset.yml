name: Atualizar CKAN - Empregados Terceirizados

on:
  push:
    branches:
      - main
    paths:
      - 'data/**'
      - 'datapackage/**'
  workflow_dispatch:

jobs:
  publish_ckan:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # =========================
      # 1. Atualizar metadados do dataset
      # =========================
      - name: Atualizar dataset no CKAN (package_update)
        env:
          CKAN_KEY: ${{ secrets.CKAN_KEY }}
        run: |
          curl -X POST "https://www.dados.mg.gov.br/api/3/action/package_update" \
            -H "Authorization: $CKAN_KEY" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "User-Agent: github-actions" \
            -d '{
              "name": "empregados-terceirizados-mg",
              "title": "Empregados Terceirizados do Governo de Minas Gerais",
              "notes": "Base anual de empregados terceirizados do Governo do Estado de Minas Gerais.",
              "owner_org": "controladoria-geral-do-estado-cge",
              "private": false,
              "state": "active"
            }'

      # =========================
      # 2. Criar / atualizar recursos (2021 e 2022)
      # =========================
      - name: Publicar recurso 2021
        env:
          CKAN_KEY: ${{ secrets.CKAN_KEY }}
        run: |
          curl -X POST "https://www.dados.mg.gov.br/api/3/action/resource_create" \
            -H "Authorization: $CKAN_KEY" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "User-Agent: github-actions" \
            -d '{
              "package_id": "empregados-terceirizados-mg",
              "name": "terceirizados-2021",
              "title": "Empregados Terceirizados – 2021",
              "format": "CSV",
              "url_type": "link",
              "url": "https://raw.githubusercontent.com/transparencia-mg/empregados_terceirizados_mg/main/data/terceirizados_2021.csv",
              "description": "Dados de empregados terceirizados do Governo de Minas Gerais – ano de 2021"
            }'

      - name: Publicar recurso 2022
        env:
          CKAN_KEY: ${{ secrets.CKAN_KEY }}
        run: |
          curl -X POST "https://www.dados.mg.gov.br/api/3/action/resource_create" \
            -H "Authorization: $CKAN_KEY" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "User-Agent: github-actions" \
            -d '{
              "package_id": "empregados-terceirizados-mg",
              "name": "terceirizados-2022",
              "title": "Empregados Terceirizados – 2022",
              "format": "CSV",
              "url_type": "link",
              "url": "https://raw.githubusercontent.com/transparencia-mg/empregados_terceirizados_mg/main/data/terceirizados_2022.csv",
              "description": "Dados de empregados terceirizados do Governo de Minas Gerais – ano de 2022"
            }'
