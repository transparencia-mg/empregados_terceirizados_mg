name: Publicar e atualizar CKAN (dados.mg.gov.br)

on:
  push:
    branches:
      - main
    paths:
      - 'data/**'
      - 'datapackage/**'
  workflow_dispatch:

jobs:
  publish_ckan:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Verificar datapackage.json
        run: |
          test -f datapackage/datapackage.json || (echo "‚ùå datapackage.json n√£o encontrado" && exit 1)

      - name: Publicar recursos no CKAN (N anos automaticamente)
        env:
          CKAN_HOST: https://www.dados.mg.gov.br
          CKAN_KEY: ${{ secrets.CKAN_KEY }}
          DATASET: empregados-terceirizados-mg
          GITHUB_REPO: transparencia-mg/empregados_terceirizados_mg
          GITHUB_BRANCH: main
        run: |
          set -e

          echo "üì¶ Lendo recursos do datapackage.json"

          for row in $(jq -c '.resources[]' datapackage/datapackage.json); do
            NAME=$(echo "$row" | jq -r '.name')
            TITLE=$(echo "$row" | jq -r '.title')
            PATH_FILE=$(echo "$row" | jq -r '.path')
            DESC=$(echo "$row" | jq -r '.description')

            URL="https://raw.githubusercontent.com/$GITHUB_REPO/$GITHUB_BRANCH/$PATH_FILE"

            echo "‚û°Ô∏è Processando recurso: $NAME"

            SEARCH=$(curl -s -X POST "$CKAN_HOST/api/3/action/resource_search" \
              -H "Authorization: $CKAN_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg n "$NAME" --arg p "$DATASET" '{query: ("name:" + $n), package_id: $p}')")

            COUNT=$(echo "$SEARCH" | jq '.result.count')

            if [ "$COUNT" -gt 0 ]; then
              ID=$(echo "$SEARCH" | jq -r '.result.results[0].id')
              ACTION="resource_update"
              PAYLOAD=$(jq -n \
                --arg id "$
