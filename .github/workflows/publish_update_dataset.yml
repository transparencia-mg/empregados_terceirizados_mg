name: Atualizar CKAN ‚Äì Empregados Terceirizados

on:
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'datapackage/**'
  workflow_dispatch:

jobs:
  publish_ckan:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Verificar datapackage
        run: |
          test -f datapackage/datapackage.json || (echo "‚ùå datapackage.json n√£o encontrado" && exit 1)

      - name: Publicar recursos no CKAN
        env:
          CKAN_HOST: https://www.dados.mg.gov.br
          CKAN_KEY: ${{ secrets.CKAN_KEY }}
          DATASET: empregados-terceirizados-mg
          GITHUB_REPO: transparencia-mg/empregados_terceirizados_mg
          GITHUB_BRANCH: main
        run: |
          set -e

          echo "üì¶ Lendo recursos do datapackage.json"

          jq -c '.resources[] | @base64' datapackage/datapackage.json | while read -r res; do
            _jq() {
              echo "$res" | base64 --decode | jq -r "$1"
            }

            NAME=$(_jq '.name')
            TITLE=$(_jq '.title')
            PATH_FILE=$(_jq '.path')
            DESC=$(_jq '.description')

            URL="https://raw.githubusercontent.com/$GITHUB_REPO/$GITHUB_BRANCH/$PATH_FILE"

            echo "‚û°Ô∏è Recurso: $NAME"

            SEARCH=$(curl -s -X POST "$CKAN_HOST/api/3/action/resource_search" \
              -H "Authorization: $CKAN_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"name:$NAME\",\"package_id\":\"$DATASET\"}")

            # üî• Prote√ß√£o contra resposta inv√°lida
            if ! echo "$SEARCH" | jq . >/dev/null 2>&1; then
              echo "‚ùå CKAN retornou resposta inv√°lida"
              echo "$SEARCH"
              exit 1
            fi

            COUNT=$(echo "$SEARCH" | jq '.result.count')

            if [ "$COUNT" -gt 0 ]; then
              ID=$(echo "$SEARCH" | jq -r '.result.results[0].id')
              ACTION="resource_update"

              PAYLOAD=$(jq -n \
                --arg id "$ID" \
                --arg pkg "$DATASET" \
                --arg name "$NAME" \
                --arg title "$TITLE" \
                --arg url "$URL" \
                --arg desc "$DESC" \
                '{
                  id: $id,
                  package_id: $pkg,
                  name: $name,
                  title: $title,
                  url: $url,
                  url_type: "link",
                  format: "CSV",
                  description: $desc
                }')

              echo "üîÑ Atualizando recurso existente"

            else
              ACTION="resource_create"

              PAYLOAD=$(jq -n \
                --arg pkg "$DATASET" \
                --arg name "$NAME" \
                --arg title "$TITLE" \
                --arg url "$URL" \
                --arg desc "$DESC" \
                '{
                  package_id: $pkg,
                  name: $name,
                  title: $title,
                  url: $url,
                  url_type: "link",
                  format: "CSV",
                  description: $desc
                }')

              echo "üÜï Criando novo recurso"
            fi

            RESPONSE=$(curl -s -X POST "$CKAN_HOST/api/3/action/$ACTION" \
              -H "Authorization: $CKAN_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            echo "$RESPONSE" | jq '.success'
          done

          echo "‚úÖ Publica√ß√£o CKAN finalizada com sucesso"
